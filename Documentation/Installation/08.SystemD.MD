## Configuration des services de base (Réseau, Son, Horloge, interface ..)

----------------------------------------------------------------------------------------------------------------
### I . Désactivation des services (Précaution)

**Chroo**
```bash
arch-chroot /mnt ;
```

```bash
clear ;
################################################################################################################
systemctl disable NetworkManager ;
systemctl disable systemd-networkd ;
systemctl disable systemd-resolved ;
systemctl disable wpa_supplicant ;
systemctl disable wpa_supplicant@wlan0 ;
systemctl disable wpa_supplicant@eth0 ;
systemctl disable iwd ;
systemctl disable ntpd ; 
################################################################################################################
systemctl enable systemd-homed ;
systemctl enable systemd-timesyncd.service ; 
################################################################################################################
echo "[Resolve]
DNS=192.168.1.1
DNS=192.168.1.40
Domains=lan" > /etc/systemd/resolved.conf ;
rm /etc/resolv.conf ;
ln -s /etc/systemd/resolved.conf /etc/resolv.conf ;
systemctl enable systemd-resolved ;
################################################################################################################
mkdir /etc/systemd/network ;
################################################################################################################
echo "[Match]
Name=lo
[Link]
RequiredForOnline=yes
[RoutingPolicyRule]
FirewallMark=300
Table=100
Family=ipv4
[Route]
Table=100
Destination=0.0.0.0/0
Type=local " > /etc/systemd/network/lo.network ;
################################################################################################################
echo "[Match]
Name=wlan0
[Network]
DHCP=no
Address=192.168.1.7/24
Gateway=192.168.1.1
DNS=192.168.1.1
DNS=192.168.1.40
Domains=lan
# IPV6 : OFF
LinkLocalAddressing=no
IPv6AcceptRA=no " > /etc/systemd/network/20-wlan0.network ;
################################################################################################################
echo "[Match]
Type=ether
[Network]
LinkLocalAddressing=ipv4
DHCP=ipv4" > /etc/systemd/network/20-eth0.network ;

systemctl enable systemd-networkd ;
################################################################################################################


echo '###############################################################################
ctrl_interface=/var/run/wpa_supplicant
ctrl_interface_group=0
eapol_version=2
ap_scan=1
fast_reauth=1
###############################################################################' > /etc/wpa_supplicant/wpa_supplicant-wlan0.conf ;
wpa_passphrase ASUS_A8_5G Azerty74@123 >> /etc/wpa_supplicant/wpa_supplicant-wlan0.conf ; # Générer la configuration ID et PASS en chiffré
echo "##############################################################################" >> /etc/wpa_supplicant/wpa_supplicant-wlan0.conf ;
cat /etc/wpa_supplicant/wpa_supplicant-wlan0.conf ;



systemctl --user enable pipewire ;
systemctl enable wpa_supplicant@wlan0 ;
systemctl enable sshd ;
systemctl enable sddm ;
systemctl enable cronie ;
```

**Redémarrer**
```bash
systemctl reboot ;
```





```
mkdir -p /etc/credentials/ /mnt/drthrax74 ;

echo "username=Drthrax74
password=Biohazard74@
vers=3.0
file_mode=0777
dir_mode=0777
workgroup=WORKGROUP" > /etc/credentials/.smbpassword ;
chmod 600 /etc/credentials/.smbpassword* ;


echo "[Unit]
Description=Montage du dossier Home
Requires=network-online.target
After=NetworkManager.service
[Mount]
What=//192.168.1.2/Home
Where=/mnt/drthrax74
Type=cifs
TimeoutSec=5s
Options=credentials=/etc/credentials/.smbpassword,uid=0,gid=0
[Install]
WantedBy=multi-user.target" > /etc/systemd/system/mnt-drthrax74.mount ;
systemctl daemon-reload ;
systemctl enable --now mnt-drthrax74.mount ;
systemctl status mnt-drthrax74.mount ;
```




```
mkdir -p /etc/credentials/ /mnt/stitch74 ;

echo "username=Stitch74
password=Stitch74@
vers=3.0
file_mode=0777
dir_mode=0777
workgroup=WORKGROUP" > /etc/credentials/.smbpassword2 ;
chmod 600 /etc/credentials/.smbpassword* ;


echo "[Unit]
Description=Montage du dossier Home
Requires=network-online.target
After=NetworkManager.service
[Mount]
What=//192.168.1.2/Home
Where=/mnt/stitch74
Type=cifs
TimeoutSec=5s
Options=credentials=/etc/credentials/.smbpassword2,uid=0,gid=0
[Install]
WantedBy=multi-user.target" > /etc/systemd/system/mnt-stitch74.mount ;
systemctl daemon-reload ;
systemctl enable --now mnt-stitch74.mount ;
systemctl status mnt-stitch74.mount ;
```







----------------------------------------------------------------------------------------------------------------
#### XI. Optimisation des services via des timers.

```
systemctl edit --force --full systemd-user-sessions.timer ;
systemctl edit --force --full systemd-resolved.timer ;
```

```bash
[Unit]
Description= Ralentir le lancement du service.

[Timer]
OnBootSec=5sec

[Install]
WantedBy=timers.target
```

```
systemctl enable --now systemd-user-sessions.timer ;
systemctl enable --now systemd-resolved.timer ;

systemctl disable --now systemd-user-sessions.timer ;
systemctl disable --now systemd-resolved.timer ;
```

----------------------------------------------------------------------------------------------------------------
#### XII. Vérification des services: 

```bash
systemctl status cronie ;
systemctl status sddm ;
systemctl status sshd ;
systemctl status systemd-homed ;
systemctl status systemd-timesyncd.service ;
systemctl status systemd-resolved ;
systemctl status systemd-networkd ;
systemctl status wpa_supplicant@wlan0 ;
systemctl status pipewire ;
systemctl status display-manager.service ;

systemctl list-unit-files --state=enabled ;
systemctl list-unit-files --state=disabled ;
```













----------------------------------------------------------------------------------------------------------------
**Observation**
```bash
#################################################################################################################
# Etat des services actif pendant l'installation #
##################################################
systemctl list-unit-files | grep enabled ;
systemctl | grep running ;


getty@.service                             enabled         enabled
netplan-ovs-cleanup.service                enabled-runtime disabled
systemd-fsck-root.service                  enabled-runtime disabled
systemd-homed-activate.service             enabled         disabled
systemd-homed.service                      enabled         enabled
systemd-networkd-wait-online.service       enabled         disabled
systemd-networkd.service                   enabled         enabled
systemd-pstore.service                     disabled        enabled
systemd-remount-fs.service                 enabled-runtime disabled
systemd-resolved.service                   enabled         enabled
systemd-timesyncd.service                  enabled         enabled
systemd-networkd.socket                    enabled         disabled
systemd-userdbd.socket                     enabled         enabled
machines.target                            disabled        enabled
reboot.target                              disabled        enabled
remote-cryptsetup.target                   disabled        enabled
remote-fs.target                           enabled         enabled
systemd-networkd-wait-online.service
systemd-homed.service
iwd.service                                enabled         disabled
```

----------------------------------------------------------------------------------------------------------------
#### X. Optimisation des services via des timers.

[root@archlinux ~]# 


**Expérimental**
```
ln -s '/usr/lib/systemd/system/sddm.service' '/etc/systemd/system/display-manager.service' ;
systemct enable display-manager.service ;
```




----------------------------------------------------------------------------------------------------------------


[SystemD](https://wiki.archlinux.fr/systemd)
[SystemD-NetworkD](https://wiki.archlinux.fr/systemd-networkd)
[Config NetworkD](https://www.moyens.net/linux/comment-configurer-systemd-networkd-sur-linux/)
[Spoofer l'interface](https://unix.stackexchange.com/questions/501928/systemd-set-mac-address-and-ip-address)

